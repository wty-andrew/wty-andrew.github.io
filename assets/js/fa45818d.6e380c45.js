"use strict";(self.webpackChunkwty_blog=self.webpackChunkwty_blog||[]).push([[542],{1759:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>g,contentTitle:()=>b,default:()=>v,frontMatter:()=>x,metadata:()=>j,toc:()=>k});var o=n(1527),s=n(7793),r=n(875),i=n(959),a=n(8630),l=n(1560),c=n(6521),d=n(280),h=n(8966);const f=e=>{const t=(0,h.Z)(`/models/${e}`),[n,o]=(0,i.useState)(null);return(0,i.useEffect)((()=>{const n=new d.Z;n.packages={clownbot_description:t},n.load(`${t}/urdf/${e}.urdf`,(e=>{e.rotation.x=-Math.PI/2,e.traverse((e=>e.castShadow=!0)),e.updateMatrixWorld(!0),o(e)}))}),[e]),n},u=()=>{const e=f("clownbot");return e&&(0,o.jsx)("primitive",{object:e,dispose:null})},p=()=>{const e=f("clownbot");return(0,a.C)((t=>{let{clock:{elapsedTime:n}}=t;if(e){const t=15*n,o=1.2*n;e.joints.base_link_to_left_wheel.setJointValue(t),e.joints.base_link_to_right_wheel.setJointValue(t),e.position.set(.5*Math.sin(o),0,.5*Math.cos(o)),e.rotation.set(-Math.PI/2,0,o)}})),e&&(0,o.jsx)("primitive",{object:e,dispose:null})},m=e=>{let{children:t,...n}=e;return(0,o.jsx)(l.Xz,{...n,children:(0,o.jsxs)(i.Suspense,{fallback:null,children:[(0,o.jsx)(c.z,{}),(0,o.jsx)("ambientLight",{intensity:.15}),(0,o.jsx)("directionalLight",{position:[-4,5,1]}),t]})})},x={title:"Load URDF with React Three Fiber"},b=void 0,j={id:"misc/r3f-urdf",title:"Load URDF with React Three Fiber",description:"URDF is the abbreviation of Unified Robot Description Format, which is an XML format for representing a robot model in ROS, we can display a model like above in browser with react three fiber through urdf-loaders.",source:"@site/notes/misc/r3f-urdf.mdx",sourceDirName:"misc",slug:"/misc/r3f-urdf",permalink:"/misc/r3f-urdf",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{title:"Load URDF with React Three Fiber"},sidebar:"tutorialSidebar",previous:{title:"Misc",permalink:"/category/misc"},next:{title:"Unorganized",permalink:"/category/unorganized"}},g={},k=[{value:"Setup",id:"setup",level:2},{value:"Option 1",id:"option-1",level:3},{value:"Option 2",id:"option-2",level:3},{value:"Make the Model Move",id:"make-the-model-move",level:2},{value:"Notes",id:"notes",level:2}];function w(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",section:"section",sup:"sup",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{style:{height:400},children:(0,o.jsx)(m,{camera:{position:[.2,.2,.2]},children:(0,o.jsx)(u,{})})}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.a,{href:"http://wiki.ros.org/urdf",children:"URDF"})," is the abbreviation of Unified Robot Description Format, which is an XML format for representing a robot model in ROS, we can display a model like above in browser with ",(0,o.jsx)(t.a,{href:"https://github.com/pmndrs/react-three-fiber",children:"react three fiber"}),(0,o.jsx)(t.sup,{children:(0,o.jsx)(t.a,{href:"#user-content-fn-1",id:"user-content-fnref-1","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"1"})})," through ",(0,o.jsx)(t.a,{href:"https://github.com/pmndrs/react-three-fiber",children:"urdf-loaders"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["In URDF, the location of a mesh file is specified under the ",(0,o.jsx)(t.code,{children:"filename"})," attribute of a mesh element with the format: ",(0,o.jsx)(t.code,{children:"package://<package_name>/path/to/<mesh_name>"}),", for example:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-xml",metastring:'title="my_pkg/urdf/foo.urdf" {3}',children:'...\n<geometry>\n  <mesh filename="package://my_pkg/meshes/bar.dae"/>\n</geometry>\n...\n'})}),"\n",(0,o.jsx)(t.p,{children:"However, URDF Loader doesn't know where to fetch the mesh files from the given path, we have two options:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsxs)(t.li,{children:["edit the URDF file by replacing all the ",(0,o.jsx)(t.code,{children:"package://<package_name>"})," part with the relative path"]}),"\n",(0,o.jsxs)(t.li,{children:["use the ",(0,o.jsx)(t.code,{children:"packages"})," option",(0,o.jsx)(t.sup,{children:(0,o.jsx)(t.a,{href:"#user-content-fn-2",id:"user-content-fnref-2","data-footnote-ref":!0,"aria-describedby":"footnote-label",children:"2"})})," of URDF Loader to resolve the paths"]}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"setup",children:"Setup"}),"\n",(0,o.jsx)(t.p,{children:"Consider the following ROS package structure"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-txt",metastring:"{3-7}",children:"my_pkg/\n\u251c\u2500\u2500 launch/\n\u251c\u2500\u2500 meshes/\n\u2502   \u251c\u2500\u2500 bar.dae\n\u2502   \u2514\u2500\u2500 baz.dae\n\u251c\u2500\u2500 urdf/\n\u2502   \u2514\u2500\u2500 foo.urdf\n\u251c\u2500\u2500 CMakeLists.txt\n\u2514\u2500\u2500 package.xml\n"})}),"\n",(0,o.jsx)(t.p,{children:"The mesh/URDF files should be copied into the public (static assets) folder of web server, assume no prefix for static files url"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-txt",metastring:"{4-10}",children:"app/\n\u251c\u2500\u2500 src/\n\u251c\u2500\u2500 public/\n\u2502   \u251c\u2500\u2500 models/\n\u2502   \u2502   \u2514\u2500\u2500 foo/\n\u2502   \u2502       \u251c\u2500\u2500 meshes/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 bar.dae\n\u2502   \u2502       \u2502   \u2514\u2500\u2500 baz.dae\n\u2502   \u2502       \u2514\u2500\u2500 urdf/\n\u2502   \u2502           \u2514\u2500\u2500 foo.urdf\n\u2502   \u2514\u2500\u2500 index.html\n\u2514\u2500\u2500 package.json\n"})}),"\n",(0,o.jsx)(t.h3,{id:"option-1",children:"Option 1"}),"\n",(0,o.jsxs)(t.p,{children:["Simply change all the occurrence of ",(0,o.jsx)(t.code,{children:"package://my_pkg"})," to ",(0,o.jsx)(t.code,{children:".."})," in URDF file, then use the ",(0,o.jsx)(t.code,{children:"useLoader"})," hook from r3f"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-tsx",children:"import { useLoader } from '@react-three/fiber'\nimport URDFLoader, { URDFRobot } from 'urdf-loader'\n\nconst FOO_URDF_URL = './models/foo/urdf/foo.urdf'\n\nconst Model = () => {\n  const robot: URDFRobot = useLoader(URDFLoader as any, FOO_URDF_URL)\n  // do whatever setup with the robot...\n  return <primitive object={robot} />\n}\n"})}),"\n",(0,o.jsx)(t.h3,{id:"option-2",children:"Option 2"}),"\n",(0,o.jsxs)(t.p,{children:["We need to initialize ",(0,o.jsx)(t.code,{children:"URDFLoader"})," ourselves in order to remap the packages, basically create a dumb version of ",(0,o.jsx)(t.code,{children:"useLoader"}),", it doesn't have suspense / cache support so is less convenient"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-tsx",metastring:"{8-10}",children:"import { useEffect, useState } from 'react'\nimport URDFLoader, { URDFRobot } from 'urdf-loader'\n\nconst Model = () => {\n  const [robot, setRobot] = useState<URDFRobot>()\n  useEffect(() => {\n    const loader = new URDFLoader()\n    loader.packages = {\n      my_pkg: './models/foo',\n    }\n    loader.load(`./models/foo/urdf/foo.urdf`, (robot) => {\n      // do whatever setup with the robot...\n      setRobot(robot)\n    })\n  }, [])\n  return robot && <primitive object={robot} />\n}\n"})}),"\n",(0,o.jsx)(t.h2,{id:"make-the-model-move",children:"Make the Model Move"}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"URDFRobot"})," extends ",(0,o.jsx)(t.code,{children:"Object3D"}),", it also provides the ",(0,o.jsx)(t.code,{children:"setJointValue"})," function that would take joint type into account."]}),"\n",(0,o.jsx)(t.p,{children:"Here's an example that changes the robot position and wheel joint values"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-tsx",children:"const maxVel = 0.6\nconst wheelRadius = 0.04\nconst trackRadius = 0.5\n\nconst Model = () => {\n  // load robot as above ...\n\n  useFrame(({ clock: { elapsedTime } }) => {\n    if (robot) {\n      // the wheels should really rotate at different speed to make the\n      // robot turn, but my eyes don't tell the difference anyway\n      const wheelAngle = elapsedTime * (maxVel / wheelRadius)\n      const theta = elapsedTime * (maxVel / trackRadius)\n      robot.joints['base_link_to_left_wheel'].setJointValue(wheelAngle)\n      robot.joints['base_link_to_right_wheel'].setJointValue(wheelAngle)\n      robot.position.set(trackRadius * Math.sin(theta), 0, trackRadius * Math.cos(theta))\n      robot.rotation.set(-Math.PI / 2, 0, theta)\n    }\n  })\n  return robot && <primitive object={robot} />\n}\n"})}),"\n",(0,o.jsx)("div",{style:{height:400},children:(0,o.jsxs)(m,{camera:{position:[0,1.2,1.2]},children:[(0,o.jsx)(r.JO,{args:[2,2],rotation:[-Math.PI/2,0,0],children:(0,o.jsx)("meshBasicMaterial",{color:"#ffb385"})}),(0,o.jsx)(p,{})]})}),"\n",(0,o.jsx)(t.h2,{id:"notes",children:"Notes"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"When doubt about the path, just open developer tools and switch to the network tab to see if the request url is correct"}),"\n",(0,o.jsxs)(t.li,{children:["The default coordinate system in ",(0,o.jsx)(t.a,{href:"https://threejs.org/",children:"three.js"})," have y-axis pointing up instead of z-axis like in most conventions, just rotate the model in x-axis by ",(0,o.jsx)(t.code,{children:"-Math.PI / 2"})]}),"\n"]}),"\n",(0,o.jsxs)(t.section,{"data-footnotes":!0,className:"footnotes",children:[(0,o.jsx)(t.h2,{className:"sr-only",id:"footnote-label",children:"Footnotes"}),"\n",(0,o.jsxs)(t.ol,{children:["\n",(0,o.jsxs)(t.li,{id:"user-content-fn-1",children:["\n",(0,o.jsxs)(t.p,{children:["A react renderer for ",(0,o.jsx)(t.a,{href:"https://threejs.org/",children:"three.js"})," ",(0,o.jsx)(t.a,{href:"#user-content-fnref-1","data-footnote-backref":"","aria-label":"Back to reference 1",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n",(0,o.jsxs)(t.li,{id:"user-content-fn-2",children:["\n",(0,o.jsxs)(t.p,{children:["The packages option is documented ",(0,o.jsx)(t.a,{href:"https://github.com/gkjohnson/urdf-loaders/tree/master/javascript#packages",children:"here"})," ",(0,o.jsx)(t.a,{href:"#user-content-fnref-2","data-footnote-backref":"","aria-label":"Back to reference 2",className:"data-footnote-backref",children:"\u21a9"})]}),"\n"]}),"\n"]}),"\n"]})]})}function v(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(w,{...e})}):w(e)}}}]);